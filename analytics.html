<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Console | Hepple Spirits</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@0;1&family=Inter:wght@200;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d0d0d; --card: #141414; --accent: #2d3a2d; --text: #e5e5e5; --border: rgba(255,255,255,0.05); }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .serif { font-family: 'Playfair Display', serif; }
        .container { max-width: 1200px; margin: 0 auto; padding: 60px 20px; }
        
        header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--border); padding-bottom: 40px; margin-bottom: 60px; }
        .label { text-transform: uppercase; letter-spacing: 0.5em; font-size: 0.7rem; color: #555; display: block; margin-bottom: 12px; }
        h1 { font-size: 4rem; margin: 0; font-style: italic; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 60px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 32px; transition: 0.4s; }
        .kpi-card:hover { border-color: rgba(255,255,255,0.1); }
        .kpi-val { font-size: 3rem; font-weight: 200; display: block; margin-top: 10px; color: #fff; }

        .dashboard-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
        .viz-card { background: var(--card); border: 1px solid var(--border); padding: 40px; height: fit-content; }
        h2 { font-size: 1.8rem; font-style: italic; margin-bottom: 40px; display: flex; align-items: center; }
        h2::after { content: ''; flex-grow: 1; height: 1px; background: var(--border); margin-left: 20px; }

        .density-row { margin-bottom: 24px; }
        .row-meta { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #888; margin-bottom: 8px; }
        .bar-bg { height: 2px; background: rgba(255,255,255,0.05); width: 100%; position: relative; }
        .bar-fill { position: absolute; height: 100%; background: var(--accent); transition: width 1.5s cubic-bezier(0.2, 0, 0, 1); }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 20px; }
        th { text-align: left; padding: 16px; color: #444; text-transform: uppercase; letter-spacing: 0.2em; border-bottom: 1px solid var(--border); font-weight: 600; }
        td { padding: 16px; border-bottom: 1px solid var(--border); color: #888; }
        tr:hover td { color: #fff; background: rgba(255,255,255,0.01); }

        .btn { border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #fff; padding: 14px 28px; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.3em; cursor: pointer; transition: 0.4s; }
        .btn:hover { background: #fff; color: #000; }

        @media (max-width: 900px) { .dashboard-layout { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <span class="label">Hepple Internal Intel</span>
                <h1 class="serif">Audience Pulse</h1>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="exportData()">Export JSON</button>
                <button class="btn" onclick="refresh()">Refresh</button>
            </div>
        </header>

        <div class="kpi-grid" id="kpi-root"></div>

        <div class="dashboard-layout">
            <div class="viz-card">
                <h2 class="serif">Interaction Density Map</h2>
                <div id="density-root"></div>
            </div>

            <div class="viz-card">
                <h2 class="serif">Engagement Velocity</h2>
                <div id="hover-root"></div>
            </div>
        </div>

        <div class="viz-card" style="margin-top: 40px; width: 100%; box-sizing: border-box;">
            <h2 class="serif">Live Stream</h2>
            <table id="stream-root">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Identifier</th>
                        <th>Route</th>
                        <th>Temporal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'hepple_intel_log';

        function refresh() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            const stats = {
                views: 0,
                clicks: {},
                hovers: {},
                routes: {},
                scrolls: 0,
                totalScroll: 0,
                dwellTimes: []
            };

            data.forEach(e => {
                if (e.event_type === 'page_view') {
                    stats.views++;
                    stats.routes[e.page] = (stats.routes[e.page] || 0) + 1;
                }
                if (e.event_type === 'click') stats.clicks[e.element_id] = (stats.clicks[e.element_id] || 0) + 1;
                if (e.event_type === 'hover') stats.hovers[e.element_id] = (hovers[e.element_id] || 0) + 1;
                if (e.event_type === 'scroll_milestone') {
                    stats.scrolls++;
                    stats.totalScroll += parseInt(e.element_id);
                }
                if (e.duration) stats.dwellTimes.push(e.duration);
            });

            // Update KPIs
            const avgDwell = stats.dwellTimes.length ? Math.floor(stats.dwellTimes.reduce((a,b)=>a+b,0)/stats.dwellTimes.length) : 0;
            const avgScroll = stats.scrolls ? Math.floor(stats.totalScroll/stats.scrolls) : 0;
            const topRoute = Object.keys(stats.routes).sort((a,b)=>stats.routes[b]-stats.routes[a])[0] || '/';

            document.getElementById('kpi-root').innerHTML = `
                <div class="kpi-card"><span class="label">Total Page Views</span><span class="serif kpi-val">${stats.views}</span></div>
                <div class="kpi-card"><span class="label">Avg Dwell Time</span><span class="serif kpi-val">${avgDwell}s</span></div>
                <div class="kpi-card"><span class="label">Avg Scroll Depth</span><span class="serif kpi-val">${avgScroll}%</span></div>
                <div class="kpi-card"><span class="label">Primary Route</span><span class="serif kpi-val" style="font-size: 1.5rem;">${topRoute}</span></div>
            `;

            // Interaction Density (Clicks)
            const sortedClicks = Object.entries(stats.clicks).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            const maxClicks = sortedClicks[0]?.[1] || 1;
            document.getElementById('density-root').innerHTML = sortedClicks.map(([id, count]) => `
                <div class="density-row">
                    <div class="row-meta"><span>${id}</span><span>${count} clicks</span></div>
                    <div class="bar-bg"><div class="bar-fill" style="width: ${(count/maxClicks)*100}%"></div></div>
                </div>
            `).join('');

            // Hover Velocity
            const sortedHovers = Object.entries(stats.hovers).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            const maxHovers = sortedHovers[0]?.[1] || 1;
            document.getElementById('hover-root').innerHTML = sortedHovers.map(([id, count]) => `
                <div class="density-row">
                    <div class="row-meta"><span>${id}</span><span>${count} focuses</span></div>
                    <div class="bar-bg"><div class="bar-fill" style="width: ${(count/maxHovers)*100}%"></div></div>
                </div>
            `).join('');

            // Stream
            const tbody = document.querySelector('#stream-root tbody');
            tbody.innerHTML = data.slice(-20).reverse().map(e => `
                <tr>
                    <td style="color: ${e.event_type === 'click' ? '#fff' : '#444'}">${e.event_type}</td>
                    <td style="color: #666">${e.element_id}</td>
                    <td style="font-style: italic">${e.page}</td>
                    <td>${new Date(e.timestamp).toLocaleTimeString()}</td>
                </tr>
            `).join('');
        }

        function exportData() {
            const data = localStorage.getItem(STORAGE_KEY);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hepple_intel_${Date.now()}.json`;
            a.click();
        }

        setInterval(refresh, 5000);
        refresh();
    </script>
</body>
</html>